# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Manifest is an economic simulation game set in the late 1700s. It models settlements, trade routes, production chains, and merchant organizations. The architecture splits simulation logic (Rust/WASM) from rendering (React/Pixi.js).

## Commands

```bash
# Development (builds WASM then starts Vite dev server)
npm run dev

# Build WASM only (outputs to web-client/src/wasm/)
npm run wasm:build

# Build WASM in debug mode (faster compilation, larger output)
npm run wasm:dev

# Type check frontend
cd web-client && npx tsc --noEmit

# Run Rust tests
cd sim-core && cargo test
```

## Architecture

### Rust Simulation Core (`sim-core/`)

Single-file library (`src/lib.rs`) compiled to WASM via `wasm-pack`. Key patterns:

- **SlotMap IDs**: `SettlementId`, `ShipId`, `OrgId`, `FacilityId` for generational indices
- **Tsify**: Derives TypeScript types automatically. Add `#[tsify(into_wasm_abi)]` to structs that cross the WASM boundary
- **Snapshot pattern**: Internal `GameState` uses SlotMaps, but `get_state_snapshot()` returns flat `StateSnapshot` with `Vec<T>` for JS consumption
- **ID serialization**: SlotMap keys become `u64` via `.0.as_ffi()` for WASM boundary

The `Simulation` struct is the WASM API surface - `#[wasm_bindgen]` methods are callable from JS.

### TypeScript Frontend (`web-client/`)

React 19 + Pixi.js v8 + Vite. State flows from WASM → React → Pixi.

- **`App.tsx`**: Holds WASM `Simulation` instance and `StateSnapshot`, passes to children
- **`GameView.tsx`**: Pixi.js `<Application>` with map rendering
- **`components/map/`**: Individual Pixi components (SettlementNode, ShipMarker, RoutesLayer)
- **`Sidebar.tsx`**: HTML UI panel for selection details and controls

Types are auto-generated by `tsify-next` into `src/wasm/sim_core.d.ts`. Re-exported from `src/types.ts`.

### WASM ↔ JS Boundary

- Types with `#[tsify(into_wasm_abi)]` serialize via `serde-wasm-bindgen` (not JSON)
- Generated `.d.ts` provides TypeScript types
- WASM loads async: `await import("./wasm/sim_core")` then `await wasm.default()`

### Pixi.js v8 with @pixi/react

Uses the `extend` API for tree-shaking:
```tsx
import { extend } from "@pixi/react";
import { Container, Graphics, Text } from "pixi.js";
extend({ Container, Graphics, Text });
// Then use <pixiContainer>, <pixiGraphics>, <pixiText>
```

For high-DPI displays, set `resolution={window.devicePixelRatio}` and `autoDensity={true}` on `<Application>`.
